<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Target Kamera</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{background:#0f172a;color:#fff;text-align:center;font-family:Arial;padding:20px;}
video{width:90%;max-width:380px;margin-top:20px;border-radius:10px;background:#000;}
button{padding:12px 20px;border:none;border-radius:8px;margin-top:20px;background:#22c55e;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>

<h2>Bagikan Kamera Anda</h2>
<p>Tekan tombol di bawah lalu beri izin kamera.</p>

<button id="start">Aktifkan Kamera</button>

<video id="localVideo" autoplay playsinline muted></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, push, update, onValue, onChildAdded } 
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxgnLu6TtJce2hd1DL07z5MWo62blEgC8",
  authDomain: "simulasi-kamera.firebaseapp.com",
  databaseURL: "https://simulasi-kamera-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "simulasi-kamera",
  storageBucket: "simulasi-kamera.firebasestorage.app",
  messagingSenderId: "924924454534",
  appId: "1:924924454534:web:8a3c34079aa1b0edd9d307"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// WebRTC
const pc = new RTCPeerConnection({ iceServers:[{ urls:"stun:stun.l.google.com:19302"}] });

const callRef  = ref(db,"room/default/call");
const callerICE = ref(db,"room/default/callerICE");
const calleeICE = ref(db,"room/default/calleeICE");

document.getElementById("start").onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    document.getElementById("localVideo").srcObject = stream;

    stream.getTracks().forEach(t => pc.addTrack(t,stream));

    update(ref(db,"room/default/status"),{ target:"ONLINE" });

    pc.onicecandidate = e => {
        if(e.candidate) push(callerICE, e.candidate.toJSON());
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await set(callRef,{ offer });

    onValue(callRef, async snap=>{
        const data = snap.val();
        if(data?.answer && !pc.currentRemoteDescription){
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });

    // Receive ICE from admin
    onChildAdded(calleeICE, snap=>{
        const cand = snap.val();
        if(cand) pc.addIceCandidate(new RTCIceCandidate(cand));
    });
};

// Jika target keluar â†’ status OFFLINE
window.onbeforeunload = () => {
    update(ref(db,"room/default/status"),{ target:"OFFLINE" });
};
</script>

</body>
</html>
